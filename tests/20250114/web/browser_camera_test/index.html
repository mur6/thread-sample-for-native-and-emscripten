<!DOCTYPE html>
<html>
<head>
    <title>Camera Histogram</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }
        #videoElement {
            width: 640px;
            height: 480px;
            background-color: #666;
        }
        #histogramCanvas {
            border: 1px solid #ccc;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <video id="videoElement" autoplay></video>
        <button id="captureButton">Capture and Calculate Histogram</button>
        <canvas id="histogramCanvas" width="512" height="256"></canvas>
    </div>

    <script>
        var Module = {
            onRuntimeInitialized: function() {
                init();
            }
        };

        async function init() {
            const video = document.getElementById('videoElement');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            // 隠れたcanvasを作成（画像キャプチャ用）
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = 640;
            captureCanvas.height = 480;
            const captureCtx = captureCanvas.getContext('2d');

            // ヒストグラム表示用のcanvas
            const histogramCanvas = document.getElementById('histogramCanvas');
            const histogramCtx = histogramCanvas.getContext('2d');

            document.getElementById('captureButton').onclick = function() {
                // ビデオフレームをキャプチャ
                captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                const imageData = captureCtx.getImageData(0, 0, captureCanvas.width, captureCanvas.height);

                // C++の処理を呼び出し
                Module.ccall('initHistogram', null, [], []);
                
                // TypedArrayをC++のメモリに転送
                const dataPtr = Module._malloc(imageData.data.length);
                Module.HEAPU8.set(imageData.data, dataPtr);
                
                Module.ccall('processImageData', null, 
                    ['number', 'number', 'number'],
                    [dataPtr, captureCanvas.width, captureCanvas.height]
                );

                // ヒストグラムデータを取得
                const histogramPtr = Module.ccall('getHistogramData', 'number', [], []);
                const histogramData = new Int32Array(Module.HEAP32.buffer, histogramPtr, 256);

                // メモリ解放
                Module._free(dataPtr);

                // ヒストグラムを描画
                drawHistogram(histogramData);
            };

            function drawHistogram(histogramData) {
                // 最大値を見つける
                const maxVal = Math.max(...histogramData);

                // キャンバスをクリア
                histogramCtx.fillStyle = 'white';
                histogramCtx.fillRect(0, 0, histogramCanvas.width, histogramCanvas.height);

                // ヒストグラムを描画
                histogramCtx.fillStyle = 'rgb(0, 0, 255)';
                const binWidth = histogramCanvas.width / 256;
                
                for (let i = 0; i < 256; i++) {
                    const height = (histogramData[i] / maxVal) * histogramCanvas.height;
                    histogramCtx.fillRect(
                        i * binWidth,
                        histogramCanvas.height - height,
                        binWidth,
                        height
                    );
                }
            }
        }
    </script>
    <script src="camera_histogram.js"></script>
</body>
</html>
